<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Patient Management API</title>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</head>
<body>
  <div class="container">
    <h1 class="mt-5">Patient Management API</h1>

    <!-- Authentication Form -->
    <div id="authForm" class="mt-3">
      <h3>Login</h3>
      <form id="loginForm">
        <div class="form-group">
          <label for="username">Username</label>
          <input type="text" class="form-control" id="username" required>
        </div>
        <div class="form-group">
          <label for="password">Password</label>
          <input type="password" class="form-control" id="password" required>
        </div>
        <button type="submit" class="btn btn-primary">Login</button>
      </form>
    </div>

    <!-- Patient Management with Tabs -->
    <div id="patientManagement" class="mt-3" style="display:none;">
      <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item">
          <a class="nav-link active" id="fetch-patients-tab" data-toggle="tab" href="#fetch-patients" role="tab" aria-controls="fetch-patients" aria-selected="true">Fetch Patients</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" id="add-patient-tab" data-toggle="tab" href="#add-patient" role="tab" aria-controls="add-patient" aria-selected="false">Add Patient</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" id="fetch-entries-tab" data-toggle="tab" href="#fetch-entries" role="tab" aria-controls="fetch-entries" aria-selected="false">Fetch Entries</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" id="add-entry-tab" data-toggle="tab" href="#add-entry" role="tab" aria-controls="add-entry" aria-selected="false">Add Entry</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" id="add-voice-note-tab" data-toggle="tab" href="#add-voice-note" role="tab" aria-controls="add-voice-note" aria-selected="false">Add Voice Note</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" id="fetch-conversations-tab" data-toggle="tab" href="#fetch-conversations" role="tab" aria-controls="fetch-conversations" aria-selected="false">Fetch Conversations</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" id="add-conversation-tab" data-toggle="tab" href="#add-conversation" role="tab" aria-controls="add-conversation" aria-selected="false">Add Conversation</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" id="chat-tab" data-toggle="tab" href="#chat" role="tab" aria-controls="chat" aria-selected="false">Chat</a>
        </li>
      </ul>
      <div class="tab-content" id="myTabContent">
        <div class="tab-pane fade show active" id="fetch-patients" role="tabpanel" aria-labelledby="fetch-patients-tab">
          <h3>Patients</h3>
          <button class="btn btn-primary mb-3" onclick="listPatients()">List All Patients</button>
          <table class="table table-bordered" id="patientsTable">
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Date of Birth</th>
                <th>Gender</th>
                <th>Address</th>
                <th>Phone Number</th>
                <th>Email</th>
                <th>Emergency Contact Name</th>
                <th>Emergency Contact Phone</th>
                <th>Medical Record Number</th>
                <th>Insurance Provider</th>
                <th>Insurance Policy Number</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="tab-pane fade" id="add-patient" role="tabpanel" aria-labelledby="add-patient-tab">
          <h4>Add New Patient</h4>
          <form id="addPatientForm" class="mt-3">
            <div class="form-group">
              <label for="patientName">Name</label>
              <input type="text" class="form-control" id="patientName" required>
            </div>
            <div class="form-group">
              <label for="dateOfBirth">Date of Birth</label>
              <input type="date" class="form-control" id="dateOfBirth" required>
            </div>
            <div class="form-group">
              <label for="gender">Gender</label>
              <input type="text" class="form-control" id="gender" required>
            </div>
            <div class="form-group">
              <label for="address">Address</label>
              <input type="text" class="form-control" id="address" required>
            </div>
            <div class="form-group">
              <label for="phoneNumber">Phone Number</label>
              <input type="text" class="form-control" id="phoneNumber" required>
            </div>
            <div class="form-group">
              <label for="email">Email</label>
              <input type="email" class="form-control" id="email" required>
            </div>
            <div class="form-group">
              <label for="emergencyContactName">Emergency Contact Name</label>
              <input type="text" class="form-control" id="emergencyContactName" required>
            </div>
            <div class="form-group">
              <label for="emergencyContactPhone">Emergency Contact Phone</label>
              <input type="text" class="form-control" id="emergencyContactPhone" required>
            </div>
            <div class="form-group">
              <label for="medicalRecordNumber">Medical Record Number</label>
              <input type="text" class="form-control" id="medicalRecordNumber" required>
            </div>
            <div class="form-group">
              <label for="insuranceProvider">Insurance Provider</label>
              <input type="text" class="form-control" id="insuranceProvider" required>
            </div>
            <div class="form-group">
              <label for="insurancePolicyNumber">Insurance Policy Number</label>
              <input type="text" class="form-control" id="insurancePolicyNumber" required>
            </div>
            <button type="submit" class="btn btn-success">Add Patient</button>
          </form>
        </div>
        <div class="tab-pane fade" id="fetch-entries" role="tabpanel" aria-labelledby="fetch-entries-tab">
          <h3>Clinical Entries</h3>
          <div class="form-group">
            <label for="entryPatientId">Patient ID</label>
            <input type="number" class="form-control" id="entryPatientId" required>
            <button class="btn btn-primary mt-3" onclick="listEntries()">List Entries</button>
          </div>
          <table class="table table-bordered" id="entriesTable">
            <thead>
              <tr>
                <th>ID</th>
                <th>Patient ID</th>
                <th>Date of Visit</th>
                <th>Time of Visit</th>
                <th>Visit Type</th>
                <th>Symptoms</th>
                <th>Diagnosis</th>
                <th>Treatment</th>
                <th>Prescribed Medications</th>
                <th>Follow-up Date</th>
                <th>Attached</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="tab-pane fade" id="add-entry" role="tabpanel" aria-labelledby="add-entry-tab">
          <h4>Add New Entry</h4>
          <form id="addEntryForm" class="mt-3">
            <div class="form-group">
              <label for="entryPatientIdInput">Patient ID</label>
              <input type="number" class="form-control" id="entryPatientIdInput" required>
            </div>
            <div class="form-group">
              <label for="entryDateOfVisit">Date of Visit</label>
              <input type="date" class="form-control" id="entryDateOfVisit">
            </div>
            <div class="form-group">
              <label for="entryTimeOfVisit">Time of Visit</label>
              <input type="time" class="form-control" id="entryTimeOfVisit">
            </div>
            <div class="form-group">
              <label for="entryVisitType">Visit Type</label>
              <input type="text" class="form-control" id="entryVisitType">
            </div>
            <div class="form-group">
              <label for="entrySymptoms">Symptoms</label>
              <textarea class="form-control" id="entrySymptoms"></textarea>
            </div>
            <div class="form-group">
              <label for="entryDiagnosis">Diagnosis</label>
              <textarea class="form-control" id="entryDiagnosis"></textarea>
            </div>
            <div class="form-group">
              <label for="entryTreatment">Treatment</label>
              <textarea class="form-control" id="entryTreatment"></textarea>
            </div>
            <div class="form-group">
              <label for="entryPrescribedMedications">Prescribed Medications</label>
              <textarea class="form-control" id="entryPrescribedMedications"></textarea>
            </div>
            <div class="form-group">
              <label for="entryFollowUpDate">Follow-up Date</label>
              <input type="date" class="form-control" id="entryFollowUpDate">
            </div>
            <button type="submit" class="btn btn-success">Add Entry</button>
          </form>
        </div>
        <div class="tab-pane fade" id="fetch-conversations" role="tabpanel" aria-labelledby="fetch-conversations-tab">
          <h3>Conversations</h3>
          <div class="form-group">
            <label for="conversationPatientId">Patient ID</label>
            <input type="number" class="form-control" id="conversationPatientId" required>
            <button class="btn btn-primary mt-3" onclick="listConversations()">List Conversations</button>
          </div>
          <table class="table table-bordered" id="conversationsTable">
            <thead>
              <tr>
                <th>ID</th>
                <th>Patient ID</th>
                <th>Session ID</th>
                <th>Created At</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="tab-pane fade" id="add-conversation" role="tabpanel" aria-labelledby="add-conversation-tab">
          <h4>Add New Conversation</h4>
          <form id="addConversationForm" class="mt-3">
            <div class="form-group">
              <label for="newConversationPatientId">Patient ID</label>
              <input type="number" class="form-control" id="newConversationPatientId" required>
            </div>
            <div class="form-group">
              <label for="sessionId">Session ID</label>
              <input type="text" class="form-control" id="sessionId" required>
            </div>
            <button type="submit" class="btn btn-success">Add Conversation</button>
          </form>
        </div>
        <div class="tab-pane fade" id="add-voice-note" role="tabpanel" aria-labelledby="add-voice-note-tab">
          <h4>Upload Audio</h4>
          <form id="uploadAudioForm" class="mt-3" enctype="multipart/form-data">
            <div class="form-group">
              <label for="audioEntryId">Entry ID</label>
              <input type="number" class="form-control" id="audioEntryId" required>
            </div>
            <div class="form-group">
              <label for="audioFile">Audio File</label>
              <input type="file" class="form-control" id="audioFile" accept="audio/*" required>
            </div>
            <button type="submit" class="btn btn-success">Upload Audio</button>
          </form>
        </div>
        <div class="tab-pane fade" id="chat" role="tabpanel" aria-labelledby="chat-tab">
          <h4>Chat with AI</h4>
          <div class="form-group">
            <label for="chatPatientId">Conversation ID</label>
            <input type="number" class="form-control" id="chatPatientId" required>
          </div>
          <div id="chatBox" class="border p-3 mb-3" style="height: 200px; overflow-y: scroll;">
            <!-- Messages will be displayed here -->
          </div>
          <form id="chatForm" class="mt-3">
            <div class="form-group">
              <input type="text" class="form-control" id="chatMessage" placeholder="Type your message here..." required>
            </div>
            <button type="submit" class="btn btn-primary">Send</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_URL = 'http://127.0.0.1:5000'; // Replace with your API URL

    // Function to handle login form submission
    $('#loginForm').submit(function(event) {
      event.preventDefault();
      const username = $('#username').val();
      const password = $('#password').val();
      $.ajax({
        type: 'POST',
        url: `${API_URL}/auth/login`,
        data: JSON.stringify({ username: username, password: password }),
        contentType: 'application/json',
        success: function(response) {
          localStorage.setItem('token', response.token);
          $('#authForm').hide();
          $('#patientManagement').show();
        },
        error: function() {
          alert('Login failed!');
        }
      });
    });

    // Function to list all patients
    function listPatients() {
      const token = localStorage.getItem('token');
      $.ajax({
        type: 'GET',
        url: `${API_URL}/patients/`,
        headers: { 'Authorization': `${token}` },
        success: function(data) {
          $('#patientsTable tbody').empty();
          data.forEach(patient => {
            $('#patientsTable tbody').append(`
              <tr>
                <td>${patient.id}</td>
                <td>${patient.name}</td>
                <td>${patient.date_of_birth}</td>
                <td>${patient.gender}</td>
                <td>${patient.address}</td>
                <td>${patient.phone_number}</td>
                <td>${patient.email}</td>
                <td>${patient.emergency_contact_name}</td>
                <td>${patient.emergency_contact_phone}</td>
                <td>${patient.medical_record_number}</td>
                <td>${patient.insurance_provider}</td>
                <td>${patient.insurance_policy_number}</td>
              </tr>
            `);
          });
        },
        error: function() {
          alert('Failed to fetch patients!');
        }
      });
    }

    // Function to list entries for a specific patient
    function listEntries() {
      const token = localStorage.getItem('token');
      const patientId = $('#entryPatientId').val();
      $.ajax({
        type: 'GET',
        url: `${API_URL}/entries/patient/${patientId}`,
        headers: { 'Authorization': `${token}` },
        success: function(data) {
          $('#entriesTable tbody').empty();
          data.forEach(entry => {
            $('#entriesTable tbody').append(`
              <tr>
                <td>${entry.id}</td>
                <td>${entry.patient_id}</td>
                <td>${entry.date_of_visit}</td>
                <td>${entry.time_of_visit}</td>
                <td>${entry.visit_type}</td>
                <td>${entry.symptoms}</td>
                <td>${entry.diagnosis}</td>
                <td>${entry.treatment}</td>
                <td>${entry.prescribed_medications}</td>
                <td>${entry.follow_up_date}</td>
              </tr>
            `);
          });
        },
        error: function() {
          alert('Failed to fetch entries!');
        }
      });
    }

    // Function to list conversations for a specific patient
    function listConversations() {
      const token = localStorage.getItem('token');
      const patientId = $('#conversationPatientId').val();
      $.ajax({
        type: 'GET',
        url: `${API_URL}/conversations/${patientId}`,
        headers: { 'Authorization': `${token}` },
        success: function(data) {
          $('#conversationsTable tbody').empty();
          data.forEach(conversation => {
            $('#conversationsTable tbody').append(`
              <tr>
                <td>${conversation.id}</td>
                <td>${conversation.patient_id}</td>
                <td>${conversation.session_id}</td>
                <td>${conversation.created_at}</td>
              </tr>
            `);
          });
        },
        error: function() {
          alert('Failed to fetch conversations!');
        }
      });
    }

    // Add new patient form submission
    $('#addPatientForm').submit(function(event) {
      event.preventDefault();
      const token = localStorage.getItem('token');
      const patientData = {
        name: $('#patientName').val(),
        date_of_birth: $('#dateOfBirth').val(),
        gender: $('#gender').val(),
        address: $('#address').val(),
        phone_number: $('#phoneNumber').val(),
        email: $('#email').val(),
        emergency_contact_name: $('#emergencyContactName').val(),
        emergency_contact_phone: $('#emergencyContactPhone').val(),
        medical_record_number: $('#medicalRecordNumber').val(),
        insurance_provider: $('#insuranceProvider').val(),
        insurance_policy_number: $('#insurancePolicyNumber').val()
      };
      $.ajax({
        type: 'POST',
        url: `${API_URL}/patients/`,
        headers: { 'Authorization': `${token}` },
        data: JSON.stringify(patientData),
        contentType: 'application/json',
        success: function() {
          listPatients();
          $('#addPatientForm')[0].reset();
        },
        error: function() {
          alert('Failed to add patient!');
        }
      });
    });

    // Add new entry form submission
    $('#addEntryForm').submit(function(event) {
    event.preventDefault();
    const token = localStorage.getItem('token');
    const entryData = {};

    // Always include patient_id
    entryData.patient_id = $('#entryPatientIdInput').val();

    // Add optional fields only if they have values
    const dateOfVisit = $('#entryDateOfVisit').val();
    if (dateOfVisit) entryData.date_of_visit = dateOfVisit;

    const timeOfVisit = $('#entryTimeOfVisit').val();
    if (timeOfVisit) entryData.time_of_visit = timeOfVisit;

    const visitType = $('#entryVisitType').val();
    if (visitType) entryData.visit_type = visitType;

    const symptoms = $('#entrySymptoms').val();
    if (symptoms) entryData.symptoms = symptoms;

    const diagnosis = $('#entryDiagnosis').val();
    if (diagnosis) entryData.diagnosis = diagnosis;

    const treatment = $('#entryTreatment').val();
    if (treatment) entryData.treatment = treatment;

    const prescribedMedications = $('#entryPrescribedMedications').val();
    if (prescribedMedications) entryData.prescribed_medications = prescribedMedications;

    const followUpDate = $('#entryFollowUpDate').val();
    if (followUpDate) entryData.follow_up_date = followUpDate;

    $.ajax({
      type: 'POST',
      url: `${API_URL}/entries/`,
      headers: { 'Authorization': `${token}` },
      data: JSON.stringify(entryData),
      contentType: 'application/json',
      success: function() {
        const patientId = $('#entryPatientIdInput').val();
        $('#entryPatientId').val(patientId);
        listEntries();
        $('#addEntryForm')[0].reset();
      },
      error: function(xhr, status, error) {
        console.error('Error details:', xhr.responseText);
        alert('Failed to add entry! ' + xhr.responseText);
      }
    });
  });

    // Add new conversation form submission
    $('#addConversationForm').submit(function(event) {
      event.preventDefault();
      const token = localStorage.getItem('token');
      const conversationData = {
        patient_id: $('#newConversationPatientId').val(),
        session_id: $('#sessionId').val()
      };
      $.ajax({
        type: 'POST',
        url: `${API_URL}/conversations`,
        headers: { 'Authorization': `${token}` },
        data: JSON.stringify(conversationData),
        contentType: 'application/json',
        success: function() {
          listConversations();
          $('#addConversationForm')[0].reset();
        },
        error: function() {
          alert('Failed to add conversation!');
        }
      });
    });

    // Upload audio form submission
    $('#uploadAudioForm').submit(function(event) {
      event.preventDefault();
      const token = localStorage.getItem('token');
      const entryId = $('#audioEntryId').val();
      const formData = new FormData();
      formData.append('audio', $('#audioFile')[0].files[0]);

      $.ajax({
        type: 'POST',
        url: `${API_URL}/speech_to_text/${entryId}`,
        headers: { 'Authorization': `${token}` },
        data: formData,
        processData: false,
        contentType: false,
        success: function() {
          alert('Audio uploaded successfully!');
        },
        error: function() {
          alert('Failed to upload audio!');
        }
      });
    });

    // Chat form submission
    $('#chatForm').submit(function(event) {
      event.preventDefault();
      const token = localStorage.getItem('token');
      const patientId = $('#chatPatientId').val();
      const message = $('#chatMessage').val();
      const conversationId = $('#chatPatientId').val(); // Replace with the actual conversation ID

      // Render the user's message first
      $('#chatBox').append(`<div><strong>You:</strong> ${message}</div>`);

      // Create a container for the AI's response
      const aiMessageContainer = $('<div><strong>AI:</strong> <span class="ai-response"></span></div>');
      $('#chatBox').append(aiMessageContainer);

      // Send the message to the server
      fetch(`${API_URL}/conversations/${conversationId}`, {
        method: 'POST',
        headers: {
          'Authorization': `${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ content: message })
      })
      .then(response => {
        const reader = response.body.getReader();
        const decoder = new TextDecoder('utf-8');
        let aiResponse = '';

        function readStream() {
          return reader.read().then(({ done, value }) => {
            if (done) {
              return;
            }
            const chunk = decoder.decode(value, { stream: true });
            aiResponse += chunk;
            aiMessageContainer.find('.ai-response').text(aiResponse);
            return readStream();
          });
        }
        
        return readStream();
      })
      .catch(error => {
        alert('Failed to send message!');
        console.error(error);
      });

      $('#chatMessage').val('');
    });
  </script>
</body>
</html>
